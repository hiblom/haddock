use std::cmp;

use crate::global::COLOR_WHITE;
use crate::global::COLOR_BLACK;
use crate::position::Position;
use crate::outcome::Outcome;
use crate::piecetype::PieceType;

const PIECE_VALUE: [i32; 12] = [
    100,-100, //pawn
      0,   0, //king
    900,-900, //queen
    500,-500, //rook
    300,-300, //bishop
    300,-300  //knight
];

const START_PIECE_VALUE_TOTAL:i32 = 
    16 * PIECE_VALUE[0] + //pawn
     4 * PIECE_VALUE[6] + //rook
     4 * PIECE_VALUE[8] + //bishop
     4 * PIECE_VALUE[10]; //knight

const END_PIECE_VALUE_THRESHOLD:i32 = 1000; //endgame threshold
const PIECE_VALUE_DIFF:i32 = START_PIECE_VALUE_TOTAL - END_PIECE_VALUE_THRESHOLD;

const PIECE_SQUARE_VALUE: [[[i32; 64]; 2]; 12] = [
    //white pawn    
    [
        [
          0,  0,  0,  0,  0,  0,  0,  0,
          5, 10, 10,-25,-25, 10, 10,  5,
          0,  0,  0,  0,  0,  0,  0,  0,
          0,  0,  0, 25, 25,  0,  0,  0,
          0,  0, 25, 25, 25, 25,  0,  0,
         10, 25, 25, 25, 25, 25, 25, 10,
         50, 50, 50, 50, 50, 50, 50, 50,
          0,  0,  0,  0,  0,  0,  0,  0
        ],
        [
          0,  0,  0,  0,  0,  0,  0,  0,
          5,  5,  5,-25,-25,  5,  5,  5,
          0,  0,  0,  0,  0,  0,  0,  0,
          0,  0,  0, 25, 25,  0,  0,  0,
          0,  0, 25, 25, 25, 25,  0,  0,
         10, 25, 25, 25, 25, 25, 25, 10,
         50, 50, 50, 50, 50, 50, 50, 50,
          0,  0,  0,  0,  0,  0,  0,  0
        ]
    ],
    //black pawn
    [
        [
          0,  0,  0,  0,  0,  0,  0,  0,
        -50,-50,-50,-50,-50,-50,-50,-50,
        -10,-25,-25,-25,-25,-25,-25,-10,
          0,  0,-25,-25,-25,-25,  0,  0,
          0,  0,  0,-25,-25,  0,  0,  0,
          0,  0,  0,  0,  0,  0,  0,  0,
         -5,-10,-10, 25, 25,-10,-10, -5,
          0,  0,  0,  0,  0,  0,  0,  0
        ],
        [
          0,  0,  0,  0,  0,  0,  0,  0,
        -50,-50,-50,-50,-50,-50,-50,-50,
        -10,-25,-25,-25,-25,-25,-25,-10,
          0,  0,-25,-25,-25,-25,  0,  0,
          0,  0,  0,-25,-25,  0,  0,  0,
          0,  0,  0,  0,  0,  0,  0,  0,
         -5, -5, -5, 25, 25, -5, -5, -5,
          0,  0,  0,  0,  0,  0,  0,  0
        ]
    ],
    //white king
    [
        [
         10, 25,  0,  0,  0,  0, 25, 10,
        -10,-10,-25,-25,-25,-25,-10,-10,
        -50,-50,-50,-50,-50,-50,-50,-50, 
        -50,-50,-50,-50,-50,-50,-50,-50,
        -50,-50,-50,-50,-50,-50,-50,-50,       
        -50,-50,-50,-50,-50,-50,-50,-50,
        -50,-50,-50,-50,-50,-50,-50,-50,
        -50,-50,-50,-50,-50,-50,-50,-50
        ],
        [
          0,  0,  0,  0,  0,  0,  0,  0,
          0,  0,  0,  0,  0,  0,  0,  0,
          0,  0,  0,  0,  0,  0,  0,  0,
          0,  0,  0,  0,  0,  0,  0,  0,
          0,  0,  0,  0,  0,  0,  0,  0,
          0,  0,  0,  0,  0,  0,  0,  0,
          0,  0,  0,  0,  0,  0,  0,  0,
          0,  0,  0,  0,  0,  0,  0,  0,
        ]
    ],
    //black king
    [
        [
         50, 50, 50, 50, 50, 50, 50, 50, 
         50, 50, 50, 50, 50, 50, 50, 50,
         50, 50, 50, 50, 50, 50, 50, 50,       
         50, 50, 50, 50, 50, 50, 50, 50,
         50, 50, 50, 50, 50, 50, 50, 50,
         50, 50, 50, 50, 50, 50, 50, 50,
         10, 10, 25, 25, 25, 25, 10, 10,
        -10,-25,  0,  0,  0,  0,-25,-10
        ],
        [
          0,  0,  0,  0,  0,  0,  0,  0,
          0,  0,  0,  0,  0,  0,  0,  0,
          0,  0,  0,  0,  0,  0,  0,  0,
          0,  0,  0,  0,  0,  0,  0,  0,
          0,  0,  0,  0,  0,  0,  0,  0,
          0,  0,  0,  0,  0,  0,  0,  0,
          0,  0,  0,  0,  0,  0,  0,  0,
          0,  0,  0,  0,  0,  0,  0,  0,
        ]
    ],
    //white queen
    [
        [
        -50,-25,-25,  0,  0,-25,-25,-50,
        -25,  0,  0,  0,  0,  0,  0,-25,
        -25,  0,  0,  0,  0,  0,  0,-25,       
        -25,  0,  0,  0,  0,  0,  0,-25,
        -25,  0,  0,  0,  0,  0,  0,-25,
        -25,  0,  0,  0,  0,  0,  0,-25,
        -25,  0,  0,  0,  0,  0,  0,-25,
        -50,-25,-25,  0,  0,-25,-25,-50
        ],
        [
        -50,-25,-25,  0,  0,-25,-25,-50,
        -25,  0,  0,  0,  0,  0,  0,-25,
        -25,  0, 10, 25, 25, 10,  0,-25,       
        -25,  0, 25, 25, 25, 25,  0,-25,
        -25,  0, 25, 25, 25, 25,  0,-25,
        -25,  0, 25, 25, 25, 25,  0,-25,
        -25,  0,  0,  0,  0,  0,  0,-25,
        -50,-25,-25,  0,  0,-25,-25,-50
        ]
    ],
    //black queen
    [
        [
        50, 25, 25,  0,  0, 25, 25, 50,
        25,  0,  0,  0,  0,  0,  0, 25,
        25,  0,  0,  0,  0,  0,  0, 25,       
        25,  0,  0,  0,  0,  0,  0, 25,
        25,  0,  0,  0,  0,  0,  0, 25,
        25,  0,  0,  0,  0,  0,  0, 25,
        25,  0,  0,  0,  0,  0,  0, 25,
        50, 25, 25,  0,  0, 25, 25, 50
        ],
        [
        50, 25, 25,  0,  0, 25, 25, 50,
        25,  0,  0,  0,  0,  0,  0, 25,
        25,  0,-25,-25,-25,-25,  0, 25,       
        25,  0,-25,-25,-25,-25,  0, 25,
        25,  0,-25,-25,-25,-25,  0, 25,
        25,  0,-10,-25,-25,-10,  0, 25,
        25,  0,  0,  0,  0,  0,  0, 25,
        50, 25, 25,  0,  0, 25, 25, 50
        ]
    ],
    //white rook
    [
        [
        -10,  0,  0, 10, 10, 10,  0,-10,
        -25,  0,  0,  0,  0,  0,  0,-25,
        -25,  0,  0,  0,  0,  0,  0,-25,       
        -25,  0,  0,  0,  0,  0,  0,-25,
        -25,  0,  0,  0,  0,  0,  0,-25,
        -25,  0,  0,  0,  0,  0,  0,-25,
        -25,  0,  0,  0,  0,  0,  0,-25,
          0,  0,  0,  0,  0,  0,  0,  0,
        ],
        [
          0,  0,  0,  0,  0,  0,  0,  0,
          0,  0,  0,  0,  0,  0,  0,  0,
          0,  0,  0,  0,  0,  0,  0,  0,
          0,  0,  0,  0,  0,  0,  0,  0,
          0,  0,  0,  0,  0,  0,  0,  0,
          0,  0,  0,  0,  0,  0,  0,  0,
          0,  0,  0,  0,  0,  0,  0,  0,
          0,  0,  0,  0,  0,  0,  0,  0,
        ]
    ],
    //black rook
    [
        [
          0,  0,  0,  0,  0,  0,  0,  0,
         25,  0,  0,  0,  0,  0,  0, 25,
         25,  0,  0,  0,  0,  0,  0, 25,       
         25,  0,  0,  0,  0,  0,  0, 25,
         25,  0,  0,  0,  0,  0,  0, 25,
         25,  0,  0,  0,  0,  0,  0, 25,
         25,  0,  0,  0,  0,  0,  0, 25,
         10,  0,  0,-10,-10,-10,  0, 10,
        ],
        [
          0,  0,  0,  0,  0,  0,  0,  0,
          0,  0,  0,  0,  0,  0,  0,  0,
          0,  0,  0,  0,  0,  0,  0,  0,
          0,  0,  0,  0,  0,  0,  0,  0,
          0,  0,  0,  0,  0,  0,  0,  0,
          0,  0,  0,  0,  0,  0,  0,  0,
          0,  0,  0,  0,  0,  0,  0,  0,
          0,  0,  0,  0,  0,  0,  0,  0,
        ]
    ],
    //white bishop
    [
        [
        -50,-25,-25,  0,  0,-25,-25,-50,
        -25, 10,  0,  0,  0,  0, 10,-25,
        -25,  0, 25,  0,  0, 25,  0,-25,       
        -25,  0,  0, 25, 25,  0,  0,-25,
        -25,  0,  0, 25, 25,  0,  0,-25,
        -25,  0, 25,  0,  0, 25,  0,-25,
        -25, 10,  0,  0,  0,  0, 10,-25,
        -50,-25,-25,  0,  0,-25,-25,-50
        ],
        [
        -50,-25,-25,  0,  0,-25,-25,-50,
        -25, 10,  0,  0,  0,  0, 10,-25,
        -25,  0, 25,  0,  0, 25,  0,-25,       
        -25,  0,  0, 25, 25,  0,  0,-25,
        -25,  0,  0, 25, 25,  0,  0,-25,
        -25,  0, 25,  0,  0, 25,  0,-25,
        -25, 10,  0,  0,  0,  0, 10,-25,
        -50,-25,-25,  0,  0,-25,-25,-50
        ]
    ],
    //black bishop
    [
        [
        50, 25, 25,  0,  0, 25, 25, 50,
        25,-10,  0,  0,  0,  0,-10, 25,
        25,  0,-25,  0,  0,-25,  0, 25,       
        25,  0,  0,-25,-25,  0,  0, 25,
        25,  0,  0,-25,-25,  0,  0, 25,
        25,  0,-25,  0,  0,-25,  0, 25,
        25,-10,  0,  0,  0,  0,-10, 25,
        50, 25, 25,  0,  0, 25, 25, 50
        ],
        [
        50, 25, 25,  0,  0, 25, 25, 50,
        25,-10,  0,  0,  0,  0,-10, 25,
        25,  0,-25,  0,  0,-25,  0, 25,
        25,  0,  0,-25,-25,  0,  0, 25,
        25,  0,  0,-25,-25,  0,  0, 25,
        25,  0,-25,  0,  0,-25,  0, 25,
        25,-10,  0,  0,  0,  0,-10, 25,
        50, 25, 25,  0,  0, 25, 25, 50
        ]
    ],
    //white knight
    [
        [
        -50,-25,-25,-25,-25,-25,-25,-50,
        -25,  0,  0,  0,  0,  0,  0,-25,
        -25,  0, 25, 25, 25, 25,  0,-25,       
        -25,  0, 26, 25, 25, 25,  0,-25,
        -25,  0, 25, 25, 25, 25,  0,-25,
        -25,  0, 25, 25, 25, 25,  0,-25,
        -25,  0,  0,  0,  0,  0,  0,-25,
        -50,-25,-25,-25,-25,-25,-25,-50
        ],
        [
        -50,-25,-25,-25,-25,-25,-25,-50,
        -25,  0,  0,  0,  0,  0,  0,-25,
        -25,  0, 25, 25, 25, 25,  0,-25,       
        -25,  0, 26, 25, 25, 25,  0,-25,
        -25,  0, 25, 25, 25, 25,  0,-25,
        -25,  0, 25, 25, 25, 25,  0,-25,
        -25,  0,  0,  0,  0,  0,  0,-25,
        -50,-25,-25,-25,-25,-25,-25,-50
        ]
    ],
    //black knight
    [
        [
         50, 25, 25, 25, 25, 25, 25, 50,
         25,  0,  0,  0,  0,  0,  0, 25,
         25,  0,-25,-25,-25,-25,  0, 25,
         25,  0,-25,-25,-25,-25,  0, 25,
         25,  0,-25,-25,-25,-25,  0, 25,       
         25,  0,-25,-25,-25,-25,  0, 25,
         25,  0,  0,  0,  0,  0,  0, 25,
         50, 25, 25, 25, 25, 25, 25, 50
        ],
        [
         50, 25, 25, 25, 25, 25, 25, 50,
         25,  0,  0,  0,  0,  0,  0, 25,
         25,  0,-25,-25,-25,-25,  0, 25,
         25,  0,-25,-25,-25,-25,  0, 25,
         25,  0,-25,-25,-25,-25,  0, 25,       
         25,  0,-25,-25,-25,-25,  0, 25,
         25,  0,  0,  0,  0,  0,  0, 25,
         50, 25, 25, 25, 25, 25, 25, 50
        ]
    ]
];

pub fn evaluate(position: &Position, depth: i32) -> Outcome {
    //TODO not enough material ??

    let material_value = get_material_value(position);
    Outcome::Undecided(depth, material_value)
}

fn get_material_value(position: &Position) -> i32 {
    let mut value: i32 = 0;
    let pos_value_total = get_pos_value_total(position);

    //anything lower than 1000 points is endgame
    let start_weight = cmp::min(pos_value_total - END_PIECE_VALUE_THRESHOLD, 0); //distance to threshold
    let end_weight = cmp::max(START_PIECE_VALUE_TOTAL - pos_value_total, PIECE_VALUE_DIFF); //distance to start


    for (piece, square) in position.get_all_active_pieces() {
        value += PIECE_VALUE[piece.to_usize()] + 
        (
            PIECE_SQUARE_VALUE[piece.to_usize()][0][square.to_usize()] * start_weight +
            PIECE_SQUARE_VALUE[piece.to_usize()][1][square.to_usize()] * end_weight
        ) / PIECE_VALUE_DIFF;
    }

    //println!("pos total {} material value is {}", pos_value_total, value);

    value
}

fn get_pos_value_total(position: &Position) -> i32 {
    return
        (
            position.get_piece_count(PieceType::new_pawn(COLOR_WHITE)) + 
            position.get_piece_count(PieceType::new_pawn(COLOR_BLACK))
        ) * PIECE_VALUE[PieceType::new_pawn(COLOR_WHITE).to_usize()] +
        (
            position.get_piece_count(PieceType::new_rook(COLOR_WHITE)) + 
            position.get_piece_count(PieceType::new_rook(COLOR_BLACK))
        ) * PIECE_VALUE[PieceType::new_rook(COLOR_WHITE).to_usize()] +
        (
            position.get_piece_count(PieceType::new_bishop(COLOR_WHITE)) + 
            position.get_piece_count(PieceType::new_bishop(COLOR_BLACK))
        ) * PIECE_VALUE[PieceType::new_bishop(COLOR_WHITE).to_usize()] +
        (
            position.get_piece_count(PieceType::new_knight(COLOR_WHITE)) + 
            position.get_piece_count(PieceType::new_knight(COLOR_BLACK))
        ) * PIECE_VALUE[PieceType::new_knight(COLOR_WHITE).to_usize()];
}